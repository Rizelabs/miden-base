<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Transaction Kernel - Polygon Miden Documentation</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../introduction/overview.html"><strong aria-hidden="true">1.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../introduction/getting-started.html"><strong aria-hidden="true">1.2.</strong> Getting started</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture.html"><strong aria-hidden="true">2.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/accounts.html"><strong aria-hidden="true">2.1.</strong> Accounts</a></li><li class="chapter-item expanded "><a href="../architecture/notes.html"><strong aria-hidden="true">2.2.</strong> Notes</a></li><li class="chapter-item expanded "><a href="../architecture/assets.html"><strong aria-hidden="true">2.3.</strong> Assets</a></li><li class="chapter-item expanded "><a href="../architecture/transactions.html"><strong aria-hidden="true">2.4.</strong> Transactions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../transactions/transaction-execution.html"><strong aria-hidden="true">2.4.1.</strong> Transaction Execution</a></li><li class="chapter-item expanded "><a href="../transactions/transaction-kernel.html" class="active"><strong aria-hidden="true">2.4.2.</strong> Transaction Kernel</a></li><li class="chapter-item expanded "><a href="../transactions/transaction-procedures.html"><strong aria-hidden="true">2.4.3.</strong> Transaction Procedures</a></li><li class="chapter-item expanded "><a href="../transactions/transaction-modes.html"><strong aria-hidden="true">2.4.4.</strong> Transaction Modes</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/state.html"><strong aria-hidden="true">2.5.</strong> State</a></li><li class="chapter-item expanded "><a href="../architecture/execution.html"><strong aria-hidden="true">2.6.</strong> Execution</a></li></ol></li><li class="chapter-item expanded "><a href="../network.html"><strong aria-hidden="true">3.</strong> Network</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../network/miden-clients.html"><strong aria-hidden="true">3.1.</strong> Miden Clients</a></li><li class="chapter-item expanded "><a href="../network/miden-node.html"><strong aria-hidden="true">3.2.</strong> Miden Node</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../miden-node/miden-node-rpc.html"><strong aria-hidden="true">3.2.1.</strong> Miden node RPC</a></li><li class="chapter-item expanded "><a href="../miden-node/miden-node-store.html"><strong aria-hidden="true">3.2.2.</strong> Miden node store</a></li><li class="chapter-item expanded "><a href="../miden-node/miden-node-block-producer.html"><strong aria-hidden="true">3.2.3.</strong> Miden node block producer</a></li></ol></li><li class="chapter-item expanded "><a href="../network/verifier-contract.html"><strong aria-hidden="true">3.3.</strong> Verifier Contract</a></li><li class="chapter-item expanded "><a href="../network/bridge.html"><strong aria-hidden="true">3.4.</strong> Bridge</a></li></ol></li><li class="chapter-item expanded "><a href="../roadmap.html"><strong aria-hidden="true">4.</strong> Roadmap</a></li><li class="chapter-item expanded "><a href="../crypto-primitives.html"><strong aria-hidden="true">5.</strong> Cryptographic primitives</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../crypto-primitives/tsmt.html"><strong aria-hidden="true">5.1.</strong> Tiered Sparse Merkle Tree (TSMT)</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Polygon Miden Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/0xPolygonMiden/miden-base/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="the-transaction-kernel-program"><a class="header" href="#the-transaction-kernel-program">The Transaction Kernel Program</a></h1>
<p>The transaction kernel program is responsible to execute a Miden rollup transaction within the Miden VM. Therefore, it is written in <a href="https://0xpolygonmiden.github.io/miden-vm/user_docs/assembly/main.html">MASM</a> and it is defined as MASM <a href="https://0xpolygonmiden.github.io/miden-vm/user_docs/assembly/execution_contexts.html#kernels">kernel</a>. The kernel provides context-sensitive security preventing unwanted read and write access. It defines a set of procedures which can be invoked from other <a href="https://0xpolygonmiden.github.io/miden-vm/user_docs/assembly/execution_contexts.html#execution-contexts">contexts</a> - e.g., notes - to be executed in the root context.</p>
<p>In general, the kernel's procedures must reflect everything users might want to do in executing transactions, from transferring assets to complex smart contract interactions with custom code. Learn more about available procedures and contexts <a href="transaction-procedures.html">here</a>.</p>
<p>The kernel has a well-defined structure which must do the following:</p>
<ol>
<li><strong>Prologue</strong>: prepares the transaction for processing by parsing the transaction data and setting up the root context.</li>
<li><strong>Note Processing</strong>: executes the note processing loop which consumes each InputNote and invokes the note script of each note.</li>
<li><strong>Transaction Script Processing</strong>: executes the optional transaction script.</li>
<li><strong>Epilogue</strong>: finalizes the transaction by computing the created notes commitment, the final account hash, asserting asset invariant conditions and asserting the nonce rules are upheld.</li>
</ol>
<p align="center">
    <img src="../diagrams/architecture/transaction/Transaction_program.png" style="width: 75%;">
</p>
<h2 id="the-inputs"><a class="header" href="#the-inputs">The Inputs</a></h2>
<p>The transaction kernel program receives two type of inputs, public inputs via the <code>operand_stack</code> and secret inputs via the <code>advice_provider</code>. The stack holds the global inputs. They serve as a commitment to the data being provided via the advice provider. The advice stack holds data of the last known block, account and input note data. The details are layed out in the next paragraph.</p>
<h2 id="the-prologue"><a class="header" href="#the-prologue">The Prologue</a></h2>
<p>The transaction prologue is executed at the beginning of a transaction. It needs to accomplish the following tasks:</p>
<ol>
<li>&quot;Unhash&quot; the inputs and lay them out in root context's memory.</li>
<li>Build a single vault (&quot;tx vault&quot;) containing assets of all inputs (input notes and initial account state).</li>
<li>Verify that all input notes are present in the Note DB.</li>
</ol>
<p>In other words, the prologue stores all provided information from the inputs and the advice provider into the appropriate memory slots. It then reads the data for account and notes from the advice provider, writes it to memory, hashes it, and verifies that the resulting hash matches the commitments provided via the stack. Finally, it creates a single vault for the assets that are involved. </p>
<p>The memory layout looks as follows. The kernel context has access to all of those memory slots. </p>
<p align="center">
    <img src="../diagrams/architecture/transaction/Memory_layout_kernel.png" style="width: 75%;">
</p>
<p>The book keeping section is needed to keep track of variables which are used internally by the transaction kernel. </p>
<p>First, all <strong>global inputs</strong> are being stored in the pre-defined memory slots. Global inputs are being provided via the <code>operand_stack</code> to the VM at transaction execution. The include the block hash, the account ID, the initial account hash, and the Nullifier commitment. This is a sequential hash of all <code>(nullifier, ZERO)</code> pairs for the notes consumed in the transaction.</p>
<p>Second, the <strong>block data</strong> is being processed. This involves reading the block data from the advice provider and storing it at the appropriate memory addresses. Block data is provided from the latest known block and consists of note, state and batch root, the block;s the previous hash and proof hash, as well as the block number. As the data is read from the advice provider, the block hash is computed. It is asserted that the computed block hash matches the block hash stored in the global inputs.</p>
<p>Third, the <strong>chain data</strong> is being processed in a similar way as the block data. In this case the chain root is being recomputed and compared against the chain root stored in the block data section. </p>
<p>Fourth, the <strong>account data</strong> is being processed. This involves reading the data from the advice provider and storing it at the appropriate memory addresses. The account data consists of roots of the account's vault, its storage and code. As the account data is read from the advice provider, the account hash is computed. If the account is new then the global initial account hash is updated and the new account is validated.  If the account already exists then it is asserted that the computed account hash matches the account hash provided via global inputs. It is also asserted that the account id matches the account id provided via the global inputs (<code>operand_stack</code>).</p>
<p>Fifth, the <strong>input notes</strong> are being processed. This involves per note reading the data from the advice provider and storing it at the appropriate memory addresses. Next to the total number of consumed notes, input note data consists of its serial number, the roots of the script, inputs and asset vault, its metadata and all its assets. As each note is consumed its hash and nullifier is computed. The transaction Nullifier commitment is computed via a sequential hash of all <code>(nullifier, ZERO)</code> pairs for all consumed notes. This step involves authentication that the input note data provided via the advice provider is consistent with the chain history. </p>
<p><em>Note: One needs to provide the note data to compute the Nullifier, e.g. the <a href="https://0xpolygonmiden.github.io/miden-base/architecture/notes.html#script">note script</a> and the <a href="https://0xpolygonmiden.github.io/miden-base/architecture/notes.html#serial-number">serial number</a>. So one needs to know the note data to execute the prologue of a transaction. This is how the <a href="https://0xpolygonmiden.github.io/miden-base/architecture/notes.html#note-recipient">note recipient</a> defines the set of users who can consume a specific note. The executing account needs to provide the pre-image data to the recipient at the time of execution.</em></p>
<p>Lastly, if a transaction script is provided, its root is being stored at the pre-defined memory address. </p>
<h2 id="the-note-processing"><a class="header" href="#the-note-processing">The Note Processing</a></h2>
<p>If there are input notes they are being consumed in a loop. For every note, the <a href="https://0xpolygonmiden.github.io/miden-vm/design/programs.html">MAST root</a> of the note script is being loaded onto the stack. Then, by calling a <a href="https://0xpolygonmiden.github.io/miden-vm/user_docs/assembly/code_organization.html?highlight=dyncall#dynamic-procedure-invocation"><code>dyncall</code></a> the note script is being executed in a new context to prevent unwanted memory access. </p>
<pre><code>    # loop while we have notes to consume
    while.true
        # execute the note setup script
        exec.note::prepare_note
        # =&gt; [NOTE_SCRIPT_HASH]

        # invoke the note script using the dyncall instruction
        dyncall
        # =&gt; [OUTPUT_3, OUTPUT_2, OUTPUT_1, OUTPUT_0]

        # clean up note script outputs
        dropw dropw dropw dropw
        # =&gt; []

        # check if we have more notes to consume and should loop again
        exec.note::increment_current_consumed_note_ptr
        loc_load.0
        neq
        # =&gt; [should_loop]
    end
</code></pre>
<p>In processing a note, the creation of a new note might be triggered. If so, all necessary information about the new note is being stored in the <em>output note data</em> in memory.</p>
<p><em>Note: The Miden Transaction Kernel Program prevents notes from having direct access to account storage. Notes can only call the account interface to trigger write operations in the account.</em></p>
<h2 id="the-transaction-script-processing"><a class="header" href="#the-transaction-script-processing">The Transaction Script Processing</a></h2>
<p>If there is a transaction script provided with the transaction, it will be processed after all notes are being consumed. By loading the transaction script root onto the stack the kernel can invoke a <code>dyncall</code> and in doing so execute the script. The transaction script is again being executed in its own context.</p>
<p>The transaction script can be used to authenticate the transaction by increasing the account's nonce and signing the transaction, see the following example:</p>
<pre><code>    use.miden::contracts::auth::basic-&gt;auth_tx

    begin
        call.auth_tx::auth_tx_rpo_falcon512
    end
</code></pre>
<p><em>Note: The executing account must expose the <code>auth_tx_rpo_falcon512</code> function in order for the transaction script to call it.</em></p>
<h2 id="the-epilogue"><a class="header" href="#the-epilogue">The Epilogue</a></h2>
<p>The Epilogue finalizes the transaction. It </p>
<ol>
<li>computes the final account hash</li>
<li>if the account has changed, assert that the final account nonce is greater than the initial
account nonce</li>
<li>computes the created notes commitment</li>
<li>asserts that the input and output vault roots are equal</li>
</ol>
<p>There is an exception for special accounts, called faucets, which can mint or burn assets. In that case input and output vault roots are not equal. </p>
<h2 id="the-outputs"><a class="header" href="#the-outputs">The Outputs</a></h2>
<p>The transaction kernel program outputs the transaction script root, a commitment of all newly created outputs notes, and the account hash in its new state. </p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../transactions/transaction-execution.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../transactions/transaction-procedures.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../transactions/transaction-execution.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../transactions/transaction-procedures.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
